# nextflow_RS2_star

## About

This repository contains a nextflow workflow treating RNAseq data.
It consits of the following steps:
- fastq (preprocessing)
- check strandedness (determine the strandedness of the input data)
- STAR index reference 
- split reads
- STAR Align to reference
- sort and convert alignement to BAM
- merge alignements of chunks
- cufflinks (transcript abuundance)

## Input

References: 
- Reference genome (fasta)
- reference transcriptome (fasta)
- genome annotation (gtf) 
To call the check strandedness, ensembl references are necessary.
Input reads: 
- paired-ends FASTQ files (single end for the moment not supported)

## Output

- Quality control file from fastp 
- transcripts abundance from cufflinks

## How to use the commonworkflowscheduler (cws)

- Setup the scheduler as desribed here: https://github.com/CommonWorkflowScheduler
- Add a scheduling strategy in the nextflow config file as described here: https://github.com/CommonWorkflowScheduler/nf-cws

## How to assign tasks generated by the splitFastq operator to certain nodes

- splitFastq uses the parameter split in the config file and represents the percentages the file gets split into

Examples:

```
split = "50 50"                2 new files with 50 percent of the original file
split = "20 20 10 50"          5 new files with 20, 20, 10 and 50 percent of the original file
split = "60 50"                Error because the percentages don't add up to 100
```

- splitFastq will rename the generated files in this patter:  \~NumberOfFile-Percentage\~{sample}.fastq 
Examples:
```
split = "50 50"
    ~01-50~{sample}.fastq
    ~02-50~{sample}.fastq
split = "20 20 10 50"
    ~01-20~{sample}.fastq
    ~02-20~{sample}.fastq
    ~03-10~{sample}.fastq
    ~04-50~{sample}.fastq
```

- The tasks will be labeled in the nextflow workflow
- the label in the config file should be named like this: NumberOfFile-Percentage
- Add a _task-label + node_ json named __myconfig__ to your config which should look like this:
  
  ```
  k8s {
   namespace = 'namespacename'
   context = 'namespacename'
   runAsUser = 0
   scheduler {
      name = 'workflow-scheduler'
      runAsUser = 0
      myconfig = [
         "01-20": "node12",
         "02-30": "node15",
         "03-50": "node12"
      ]
    } 
  }
  ```

  - All other tasks (whose label are not in the __myconfig__) will be scheduled using the strategy FairAssig
    
## How to run the workflow

```
nextflow run path/to/nextflow_RS2_star -c nextflow.config -w /path/to/workdir
```

How to run on the FONDA cluster:
```
nextflow kuberun Nine-s/nextflow_RS2_star -r main -c nextflow.config -v nextflow-ninon:/workdir
```

The configuration files are available in the `config` directory.
